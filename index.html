<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>30-Day Abs Challenge Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js CDN for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Custom styles for the app */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5; /* Light gray background */
        }
        .container {
            max-width: 1200px;
        }
        th, td {
            padding: 0.75rem; /* Add some padding to table cells */
            border-bottom: 1px solid #e2e8f0; /* Light border for rows */
        }
        th {
            background-color: #4F81BD; /* Header blue */
            color: white;
            text-align: center;
            font-weight: bold;
        }
        td {
            text-align: center;
        }
        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #cbd5e0; /* border-gray-300 */
            background-color: #ffffff; /* bg-white */
            transition: all 0.2s ease-in-out;
        }
        input:focus,
        select:focus {
            outline: none;
            border-color: #3B82F6; /* ring-blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25); /* ring-blue-500/25 */
        }
        .message-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1000;
        }
        .message-box.show {
            opacity: 1;
        }
        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Basic styling for markdown elements rendered by marked.js */
        #aiGuidanceContent h1 { font-size: 1.8em; margin-bottom: 0.5em; }
        #aiGuidanceContent h2 { font-size: 1.5em; margin-bottom: 0.4em; }
        #aiGuidanceContent p { margin-bottom: 1em; }
        #aiGuidanceContent ul { list-style-type: disc; margin-left: 20px; margin-bottom: 1em;}
        #aiGuidanceContent ol { list-style-type: decimal; margin-left: 20px; margin-bottom: 1em;}
        #aiGuidanceContent strong { font-weight: bold; }
        #aiGuidanceContent em { font-style: italic; }
    </style>
</head>
<body class="p-4">
    <div class="container mx-auto bg-white rounded-lg shadow-xl overflow-hidden mb-8">
        <!-- Overview + Guide Section -->
        <div class="p-6">
            <h1 class="text-3xl font-bold text-center py-4 rounded-t-lg text-white bg-blue-700"
                style="background-color: #4F81BD;">
                30-Day Visible Abs Challenge (TDEE: 2950)
            </h1>
            <div class="grid md:grid-cols-2 gap-6 mt-6 p-4 border border-gray-200 rounded-lg">
                <div>
                    <h2 class="text-xl font-bold text-blue-700 mb-2">Welcome!</h2>
                    <p class="text-gray-700">This tracker helps you reach visible abs in 30 days with your updated TDEE of 2950 kcal.</p>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-blue-700 mb-2">Calories:</h2>
                    <p class="text-gray-700">Your daily calorie intake goal is ~2200-2450 kcal (500-750 kcal deficit).</p>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-blue-700 mb-2">Workouts:</h2>
                    <p class="text-gray-700">Include Jumping Jacks, High Knees, Crunches, Leg Raises, Planks, Full Body HIIT, and active rest days (walk or yoga).</p>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-blue-700 mb-2">Logging:</h2>
                    <p class="text-gray-700">Each day, record your weight, waist, calories consumed, calories burned, and workout status.</p>
                </div>
                <div class="md:col-span-2">
                    <h2 class="text-xl font-bold text-blue-700 mb-2">Tips for Success:</h2>
                    <ul class="list-disc list-inside text-gray-700">
                        <li>Take weekly progress photos.</li>
                        <li>Measure your waist circumference weekly (or bi-weekly).</li>
                        <li>Hydrate frequently throughout the day.</li>
                        <li>Aim for 7-8 hours of quality sleep every night.</li>
                        <li>Stay consistent with your diet and exercise plan.</li>
                        <li>Focus on lean protein and abundant vegetables.</li>
                        <li>Strictly control rice/noodle portions.</li>
                    </ul>
                </div>
                <div class="md:col-span-2">
                    <h2 class="text-xl font-bold text-blue-700 mb-2">Legend:</h2>
                    <ul class="list-disc list-inside text-gray-700">
                        <li class="font-bold text-yellow-600">Yellow cells: Input fields for your daily data.</li>
                        <li class="font-bold text-blue-600">Blue text: Suggested workout types based on day of the week.</li>
                        <li>"Y/N" dropdown for logging workout completion.</li>
                        <li>Net Calories are calculated automatically.</li>
                    </ul>
                </div>
            </div>

            <!-- Authentication Section -->
            <div id="authSection" class="mt-6 p-4 bg-blue-100 rounded-lg border border-blue-300">
                <h2 class="text-xl font-bold text-blue-700 mb-3 text-center">Account Access</h2>
                <div id="loginForm" class="space-y-4">
                    <div>
                        <label for="emailInput" class="block text-gray-700 text-sm font-bold mb-1">Email:</label>
                        <input type="email" id="emailInput" placeholder="your@example.com" class="w-full p-2 rounded-md border border-gray-300">
                    </div>
                    <div>
                        <label for="passwordInput" class="block text-gray-700 text-sm font-bold mb-1">Password:</label>
                        <input type="password" id="passwordInput" placeholder="********" class="w-full p-2 rounded-md border border-gray-300">
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4">
                        <button id="loginBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-all duration-300">
                            Log In
                        </button>
                        <button id="signupBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-all duration-300">
                            Sign Up
                        </button>
                    </div>
                    <div class="text-center mt-4">
                        <span class="text-gray-600">OR</span>
                    </div>
                    <div class="flex justify-center mt-4">
                        <button id="googleLoginBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-all duration-300 flex items-center">
                            <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12.24 10.29C11.66 10.11 11.02 10 10.35 10C8.01 10 6 11.56 6 14.15C6 16.74 8.01 18.3 10.35 18.3C11.95 18.3 13.06 17.5 13.79 16.79L16.48 19.48C14.73 21.1 12.35 22 9.99 22C4.54 22 0 17.05 0 11C0 4.95 4.54 0 9.99 0C15.01 0 18.23 3.65 18.23 8.88C18.23 9.4 18.17 9.9 18.06 10.39L12.24 10.29Z" fill="#EA4335"/>
                                <path d="M12.24 10.29C12.42 9.71 12.49 9.11 12.49 8.48C12.49 7.84 12.42 7.23 12.24 6.64L18.06 6.55C18.17 7.03 18.23 7.53 18.23 8.04C18.23 13.27 15.01 16.92 9.99 16.92C7.65 16.92 5.64 15.36 5.64 12.77C5.64 10.18 7.65 8.62 9.99 8.62C11.02 8.62 11.66 8.79 12.24 8.97L12.24 10.29Z" fill="#FBBC04"/>
                                <path d="M22.06 12C22.06 12.75 22 13.49 21.89 14.22L12.01 14.22L12.01 10.29L21.89 10.29C21.95 10.51 22.06 10.74 22.06 11C22.06 11.39 22.01 11.77 21.94 12.14L22.06 12Z" fill="#4285F4"/>
                                <path d="M10.35 18.3C11.95 18.3 13.06 17.5 13.79 16.79L16.48 19.48C14.73 21.1 12.35 22 9.99 22C4.54 22 0 17.05 0 11C0 4.95 4.54 0 9.99 0C15.01 0 18.23 3.65 18.23 8.88C18.23 9.4 18.17 9.9 18.06 10.39L12.24 10.29Z" fill="#34A853"/>
                            </svg>
                            Sign in with Google
                        </button>
                    </div>
                </div>
                <div id="userInfo" class="hidden text-center mt-4">
                    <p class="text-gray-800 text-lg">Logged in as: <span id="userEmail" class="font-semibold"></span> (<span id="userIdDisplay" class="font-semibold text-sm"></span>)</p>
                    <button id="logoutBtn" class="mt-3 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-all duration-300">
                        Log Out
                    </button>
                </div>
            </div>

            <!-- Removed the API Key Input Section -->

            <div class="mt-6 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="getAIGuidanceBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-all duration-300">
                    Get AI Guidance
                </button>
                <button id="resetDataBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-all duration-300">
                    Reset All Data
                </button>
            </div>

            <!-- AI Guidance Section -->
            <div id="aiGuidanceSection" class="mt-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h2 class="text-xl font-bold text-blue-700 mb-3 text-center">Your AI Fitness Coach</h2>
                <div id="aiGuidanceContent" class="text-gray-800 leading-relaxed min-h-[50px] flex items-center justify-center">
                    <p class="text-center text-gray-500">Click "Get AI Guidance" to receive personalized feedback!</p>
                </div>
            </div>
        </div>

        <!-- 30-Day Tracker Section -->
        <div id="appContent" class="p-6 overflow-x-auto hidden">
            <h2 class="text-2xl font-bold text-blue-700 mb-4 text-center">30-Day Tracker</h2>
            <table class="min-w-full bg-white rounded-lg overflow-hidden border border-gray-200">
                <thead>
                    <tr>
                        <th class="py-3 px-4 border border-gray-300">Date</th>
                        <th class="py-3 px-4 border border-gray-300">Calories Consumed (kcal)</th>
                        <th class="py-3 px-4 borderParsed(base64ImageData) border-gray-300">Calories Burned (Workout) (kcal)</th>
                        <th class="py-3 px-4 border border-gray-300">Net Calories (kcal)</th>
                        <th class="py-3 px-4 border border-gray-300">Weight (kg)</th>
                        <th class="py-3 px-4 border border-gray-300">Waist Circumference (cm)</th>
                        <th class="py-3 px-4 border border-gray-300">Workout Done? (Y/N)</th>
                        <th class="py-3 px-4 border border-gray-300">Workout Type</th>
                        <th class="py-3 px-4 border border-gray-300">Comments / Notes</th>
                    </tr>
                </thead>
                <tbody id="trackerBody">
                    <!-- Data will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Message Box for User Feedback -->
    <div id="messageBox" class="message-box"></div>

    <script type="module">
        // Import Firebase modules directly in this script block
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Firebase project configuration - THIS KEY REMAINS UNTOUCHED as requested.
        const firebaseConfig = {
            apiKey: "AIzaSyAYY1aQymBWfb56rSMvcgpX92Sz7qGd-mc", // Firebase API Key
            authDomain: "fitnesstrackerpro-20c66.firebaseapp.com",
            projectId: "fitnesstrackerpro-20c66",
            storageBucket: "fitnesstrackerpro-20c66.firebasestorage.app",
            messagingSenderId: "538496930878",
            appId: "1:538496930878:web:34c461143490facc6aed6f"
        };
        console.log("Firebase config being used:", firebaseConfig);

        // Gemini API Key - THIS KEY IS NOW HARDCODED as requested.
        const GEMINI_API_KEY = "AIzaSyBY0Fx-V2DbfzJvfiRc_ZGrGSiow1ETUjA";


        // Explicitly attach these to window to ensure global accessibility in all contexts/callbacks
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.currentUnsubscribe = null; // To manage Firestore snapshot listener for trackerData
        window.trackerData = []; // Main data array for the tracker

        const localStorageKey = 'absTrackerData'; // LocalStorage for initial data migration

        const TDEE = 2950; // User's provided TDEE
        const TARGET_CAL_MIN = 2200; // Lower end of target calorie intake
        const TARGET_CAL_MAX = 2450; // Upper end of target calorie intake

        /**
         * Displays a temporary message box for user feedback.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error' to change background color.
         */
        function showMessageBox(message, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = 'message-box show'; // Reset classes and show

            if (type === 'success') {
                messageBox.style.backgroundColor = '#4CAF50'; // Green
            } else if (type === 'error') {
                messageBox.style.backgroundColor = '#f44336'; // Red
            }

            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        // --- Firebase Firestore Helpers ---
        /**
         * Returns the Firestore document reference for user's tracker data.
         * @param {string} uid - The user's UID.
         * @returns {object} Firestore DocumentReference.
         */
        function getTrackerDocRef(uid) {
            return doc(window.db, `artifacts/${appId}/users/${uid}/trackerData`, 'current');
        }

        /**
         * Returns the Firestore document reference for user's settings (e.g., API key).
         * NOTE: This is primarily for other potential settings, not for the hardcoded Gemini API key anymore.
         * @param {string} uid - The user's UID.
         * @returns {object} Firestore DocumentReference.
         */
        function getUserSettingsDocRef(uid) {
            return doc(window.db, `artifacts/${appId}/users/${uid}/settings`, 'config');
        }

        // --- Data Management Functions ---
        /**
         * Initializes the 30-day tracker data and saves it to Firestore.
         * This is called only when a user logs in for the first time or after a data reset.
         */
        async function initializeTrackerDataAndSave() {
            console.log("initializeTrackerDataAndSave: Starting data initialization.");
            const defaultTrackerData = [];
            const startDate = new Date(); // Start from today
            const defaultCalorieIntake = 2200;

            for (let i = 0; i < 30; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const weekday = currentDate.getDay();

                let workoutType;
                let caloriesBurnedWorkout;

                if (weekday === 6) { // Saturday
                    workoutType = "Full Body HIIT: 4 rounds (burpees, high knees, mountain climbers)";
                    caloriesBurnedWorkout = 300;
                } else if (weekday === 0) { // Sunday
                    workoutType = "Active Rest: 30â€“45 min walk or yoga";
                    caloriesBurnedWorkout = 120;
                } else { // Weekdays
                    workoutType = "Core Circuit: Jumping jacks, high knees, crunches, leg raises, planks";
                    caloriesBurnedWorkout = 200;
                }

                const caloriesConsumed = defaultCalorieIntake;
                const netCalories = caloriesConsumed - caloriesBurnedWorkout;

                defaultTrackerData.push({
                    date: currentDate.toISOString().split('T')[0],
                    caloriesConsumed: caloriesConsumed,
                    caloriesBurned: caloriesBurnedWorkout,
                    netCalories: netCalories,
                    weight: '',
                    waist: '',
                    workoutDone: '',
                    workoutType: workoutType,
                    comments: 'Log your progress and any notes.'
                });
            }

            if (window.userId && window.db) {
                try {
                    const trackerDocRef = getTrackerDocRef(window.userId);
                    // Use setDoc here to explicitly create or overwrite the document for initial setup
                    await setDoc(trackerDocRef, { data: defaultTrackerData });
                    console.log("initializeTrackerDataAndSave: Initial tracker data successfully created and saved to Firestore.");
                    // Update window.trackerData and render immediately for responsiveness
                    window.trackerData = defaultTrackerData;
                    renderTable(); // Re-render table with newly initialized data
                } catch (e) {
                    console.error("initializeTrackerDataAndSave: Error initializing and saving data to Firestore:", e);
                    showMessageBox("Error setting up initial data.", 'error');
                }
            } else {
                 console.log("initializeTrackerDataAndSave: userId or db not available, cannot save initial data to Firestore.");
            }
        }

        /**
         * Loads data from Firestore (if logged in) or initializes new tracker data.
         * Handles migration from localStorage if it exists for a newly logged-in user.
         */
        async function loadTrackerAndSettingsData() {
            console.log("loadTrackerAndSettingsData: Function called.");
            if (window.userId && window.db) { // Ensure db is also available before proceeding
                if (window.currentUnsubscribe) {
                    window.currentUnsubscribe(); // Detach previous listener
                    console.log("loadTrackerAndSettingsData: Previous Firestore listener detached.");
                }
                console.log("loadTrackerAndSettingsData: Loading tracker and settings data for user:", window.userId);

                const trackerDocRef = getTrackerDocRef(window.userId);

                // Check for local storage migration before setting up listener to avoid race conditions
                const localTrackerData = localStorage.getItem(localStorageKey);
                if (localTrackerData) {
                    console.log("loadTrackerAndSettingsData: Found local storage data. Checking Firestore existence...");
                    const firestoreTrackerDoc = await getDoc(trackerDocRef);
                    if (!firestoreTrackerDoc.exists()) {
                        try {
                            const parsedLocalData = JSON.parse(localTrackerData);
                            await setDoc(trackerDocRef, { data: parsedLocalData }); // Use setDoc without merge for new doc
                            localStorage.removeItem(localStorageKey);
                            showMessageBox("Local tracker data migrated to your account!", 'success');
                            console.log("loadTrackerAndSettingsData: Local tracker data successfully migrated to Firestore.");
                        } catch (e) {
                            console.error("loadTrackerAndSettingsData: Failed to migrate local tracker data:", e);
                            showMessageBox("Error migrating local tracker data.", 'error');
                        }
                    } else {
                        localStorage.removeItem(localStorageKey); // Clear local data if Firestore already has data
                        console.log("loadTrackerAndSettingsData: Local storage data found but Firestore already has data, clearing local storage.");
                    }
                }

                // Set up real-time listener for tracker data
                window.currentUnsubscribe = onSnapshot(trackerDocRef, (docSnap) => {
                    console.log("onSnapshot: Callback triggered. docSnap.exists():", docSnap.exists());
                    const dataFromFirestore = docSnap.data();
                    if (docSnap.exists() && dataFromFirestore && Array.isArray(dataFromFirestore.data)) {
                        // Data exists and is an array, process and render
                        let fetchedData = dataFromFirestore.data;
                        console.log("onSnapshot: Fetched data from Firestore, number of items:", fetchedData.length, fetchedData);
                        window.trackerData = fetchedData.map(day => ({
                            date: day.date,
                            caloriesConsumed: parseInt(day.caloriesConsumed) || 0,
                            caloriesBurned: parseInt(day.caloriesBurned) || 0,
                            netCalories: (parseInt(day.caloriesConsumed) || 0) - (parseInt(day.caloriesBurned) || 0),
                            weight: day.weight || '',
                            waist: day.waist || '',
                            workoutDone: day.workoutDone || '',
                            workoutType: day.workoutType || '',
                            comments: day.comments || ''
                        }));
                        renderTable(); // Always render after data is set
                        showMessageBox("Tracker data synced!", 'success');
                        console.log(`onSnapshot: Tracker data fetched and synced from Firestore. ${window.trackerData.length} items.`);
                    } else {
                        // Document does NOT exist, or its 'data' field is missing/not an array, or it's an empty array.
                        // In all these cases, we want to ensure fresh data is initialized.
                        console.log("onSnapshot: Firestore tracker document missing, or data is empty/malformed. Triggering data initialization.");
                        initializeTrackerDataAndSave(); // This will create/overwrite and then trigger this onSnapshot again.
                    }
                }, (error) => {
                    console.error("onSnapshot: Error fetching tracker data from Firestore:", error);
                    showMessageBox("Error loading data from account. Try logging out/in.", 'error');
                    window.trackerData = []; // Clear data on error
                    renderTable(); // Clear table display
                });

            } else { // Not logged in, clear UI
                console.log("loadTrackerAndSettingsData: User not logged in or db not available. Clearing UI.");
                window.trackerData = [];
                renderTable(); // Ensure table is empty
                document.getElementById('appContent').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('userInfo').classList.add('hidden');
            }
        }

        /**
         * Saves the current tracker data to Firestore.
         */
        async function saveData() {
            if (window.userId && window.db) {
                try {
                    const trackerDocRef = getTrackerDocRef(window.userId);
                    await setDoc(trackerDocRef, { data: window.trackerData }, { merge: true }); // Use merge for updates
                    console.log("saveData: Tracker data successfully saved to Firestore.");
                    // showMessageBox("Data saved!", 'success'); // Commented out to avoid spamming messages on every input change
                } catch (e) {
                    console.error("saveData: Error saving data to Firestore:", e);
                    showMessageBox("Error saving data to account.", 'error');
                }
            } else {
                console.log("saveData: User not logged in or db not available, data not saved to Firestore.");
                // showMessageBox("Login to save your progress!", 'error'); // Commented out to avoid spamming messages
            }
        }


        /**
         * Renders the tracker data into the HTML table.
         */
        function renderTable() {
            const trackerBody = document.getElementById('trackerBody');
            trackerBody.innerHTML = ''; // Clear existing rows

            console.log("renderTable: Rendering table with", window.trackerData.length, "items."); // Debugging line

            if (window.trackerData.length === 0) {
                console.log("renderTable: No data in window.trackerData to render.");
                // Optionally display a message that data is loading or missing
                const noDataRow = trackerBody.insertRow();
                const cell = noDataRow.insertCell();
                cell.colSpan = 9; // Span across all columns
                cell.textContent = "No tracker data available. Logging in or resetting data might help.";
                cell.className = "text-center text-gray-500 py-4";
                return;
            }

            window.trackerData.forEach((day, index) => {
                const row = trackerBody.insertRow();
                row.className = 'hover:bg-gray-50 transition-colors duration-200';

                // Date
                const dateCell = row.insertCell();
                dateCell.textContent = day.date;
                dateCell.className = 'text-gray-800 font-semibold';

                // Calories Consumed (editable)
                const calConsumedCell = row.insertCell();
                const calConsumedInput = document.createElement('input');
                calConsumedInput.type = 'number';
                calConsumedInput.value = day.caloriesConsumed;
                calConsumedInput.className = 'w-24 p-2 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500 bg-yellow-100'; // Yellow for input
                calConsumedInput.addEventListener('input', (e) => {
                    const newValue = parseInt(e.target.value) || 0;
                    window.trackerData[index].caloriesConsumed = newValue;
                    window.trackerData[index].netCalories = newValue - (parseInt(window.trackerData[index].caloriesBurned) || 0);
                    row.cells[3].textContent = window.trackerData[index].netCalories; // Update net calories cell
                    saveData();
                });
                calConsumedCell.appendChild(calConsumedInput);

                // Calories Burned (Workout) (editable)
                const calBurnedCell = row.insertCell();
                const calBurnedInput = document.createElement('input');
                calBurnedInput.type = 'number';
                calBurnedInput.value = day.caloriesBurned;
                calBurnedInput.className = 'w-24 p-2 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500 bg-yellow-100'; // Yellow for input
                calBurnedInput.addEventListener('input', (e) => {
                    const newValue = parseInt(e.target.value) || 0;
                    window.trackerData[index].caloriesBurned = newValue;
                    window.trackerData[index].netCalories = (parseInt(window.trackerData[index].caloriesConsumed) || 0) - newValue;
                    row.cells[3].textContent = window.trackerData[index].netCalories; // Update net calories cell
                    saveData();
                });
                calBurnedCell.appendChild(calBurnedInput);

                // Net Calories (calculated)
                const netCalCell = row.insertCell();
                netCalCell.textContent = day.netCalories;
                netCalCell.className = 'text-gray-800 font-bold'; // Auto-calculated, not editable directly

                // Weight (editable)
                const weightCell = row.insertCell();
                const weightInput = document.createElement('input');
                weightInput.type = 'number';
                weightInput.step = '0.1'; // Allow decimal for weight
                weightInput.value = day.weight;
                weightInput.className = 'w-24 p-2 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500 bg-yellow-100';
                weightInput.addEventListener('input', (e) => {
                    window.trackerData[index].weight = e.target.value;
                    saveData();
                });
                weightCell.appendChild(weightInput);

                // Waist Circumference (editable)
                const waistCell = row.insertCell();
                const waistInput = document.createElement('input');
                waistInput.type = 'number';
                waistInput.step = '0.1'; // Allow decimal for waist
                waistInput.value = day.waist;
                waistInput.className = 'w-24 p-2 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500 bg-yellow-100';
                waistInput.addEventListener('input', (e) => {
                    window.trackerData[index].waist = e.target.value;
                    saveData();
                });
                waistCell.appendChild(waistInput);

                // Workout Done? (Y/N dropdown)
                const workoutDoneCell = row.insertCell();
                const workoutDoneSelect = document.createElement('select');
                workoutDoneSelect.className = 'w-24 p-2 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500 bg-yellow-100';
                ['', 'Y', 'N'].forEach(optionValue => {
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionValue;
                    if (optionValue === day.workoutDone) {
                        option.selected = true;
                    }
                    workoutDoneSelect.appendChild(option);
                });
                workoutDoneSelect.addEventListener('change', (e) => {
                    window.trackerData[index].workoutDone = e.target.value;
                    saveData();
                });
                workoutDoneCell.appendChild(workoutDoneSelect);

                // Workout Type (suggested, non-editable by user)
                const workoutTypeCell = row.insertCell();
                workoutTypeCell.textContent = day.workoutType;
                workoutTypeCell.className = 'text-blue-600 text-sm italic text-left'; // Blue for suggestion

                // Comments / Notes (editable)
                const commentsCell = row.insertCell();
                const commentsInput = document.createElement('input');
                commentsInput.type = 'text';
                commentsInput.value = day.comments;
                commentsInput.className = 'w-full p-2 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500 bg-yellow-100';
                commentsInput.addEventListener('input', (e) => {
                    window.trackerData[index].comments = e.target.value;
                    saveData();
                });
                commentsCell.appendChild(commentsInput);
            });
        }

        /**
         * Gets AI guidance based on the current day's logged data.
         */
        async function getAIGuidance() {
            const aiGuidanceContent = document.getElementById('aiGuidanceContent');
            const geminiApiKey = GEMINI_API_KEY;

            if (!geminiApiKey) {
                aiGuidanceContent.innerHTML = '<p class="text-center text-red-500">Gemini API Key is missing from configuration.</p>';
                showMessageBox("Gemini API Key not set.", 'error');
                console.error("AI Guidance: Gemini API Key is missing from configuration.");
                return;
            }
            if (!window.userId) {
                aiGuidanceContent.innerHTML = '<p class="text-center text-red-500">Please log in to use AI guidance.</p>';
                showMessageBox("Please log in to use AI guidance.", 'error');
                console.error("AI Guidance: User not logged in.");
                return;
            }


            aiGuidanceContent.innerHTML = '<div class="loader"></div><p class="mt-2 text-center text-gray-500">Getting personalized advice...</p>'; // Show loading
            console.log("Requesting AI guidance...");

            const today = new Date().toISOString().split('T')[0];
            const currentDayData = window.trackerData.find(day => day.date === today);

            if (!currentDayData) {
                aiGuidanceContent.innerHTML = '<p class="text-center text-red-500">No data found for today. Please log some progress first!</p>';
                showMessageBox("Please log data for today first.", 'error');
                console.error("AI Guidance: No data found for today.");
                return;
            }

            const prompt = `You are a fitness coach guiding a user on a 30-day abs challenge. The user's goal is to achieve visible abs.
Their TDEE is ${TDEE} kcal. Their daily target calorie intake is ${TARGET_CAL_MIN}-${TARGET_CAL_MAX} kcal.
Here is today's logged data:
Date: ${currentDayData.date}
Calories Consumed: ${currentDayData.caloriesConsumed || 'Not logged'} kcal
Calories Burned (Workout): ${currentDayData.caloriesBurned || 'Not logged'} kcal
Net Calories: ${currentDayData.netCalories || 'Not logged'} kcal (Calculated as Consumed - Burned)
Weight: ${currentDayData.weight || 'Not logged'} kg
Waist Circumference: ${currentDayData.waist || 'Not logged'} cm
Workout Done: ${currentDayData.workoutDone || 'Not logged'}
Workout Type: ${currentDayData.workoutType}
Comments: ${currentDayData.comments || 'No comments'}

Based on this, please provide concise, encouraging, and actionable guidance for their progress for today and tomorrow. If the logged calories are significantly off target, gently suggest adjusting. If weight/waist are not logged, prompt them to do so. If the workout is not done, encourage consistency. Focus on practical, daily advice for someone in a calorie deficit aiming for muscle definition. Keep your response relatively brief, under 200 words.`;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // Use the hardcoded Gemini API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    // Use marked.js to convert markdown to HTML
                    aiGuidanceContent.innerHTML = marked.parse(text);
                    showMessageBox("AI guidance received!", 'success');
                    console.log("AI Guidance: Successfully received AI response.");
                } else {
                    aiGuidanceContent.innerHTML = '<p class="text-center text-red-500">Failed to get AI guidance. Please try again. (Check API Key or response structure)</p>';
                    showMessageBox("AI response error.", 'error');
                    console.error("AI Guidance: Unexpected AI response structure:", result);
                }
            }
            catch (error) {
                aiGuidanceContent.innerHTML = '<p class="text-center text-red-500">Error connecting to AI. Check your network or try again later.</p>';
                showMessageBox("Network or API error.", 'error');
                console.error("AI Guidance: Error fetching AI guidance:", error);
            }
        }

        // --- Authentication Handlers ---
        async function handleLogin() {
            console.log("handleLogin function called.");
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            if (!email || !password) {
                showMessageBox("Please enter both email and password.", 'error');
                console.error("Login attempt failed: Email or password missing.");
                return;
            }
            if (!window.auth) {
                showMessageBox("Firebase Auth not initialized. Cannot log in. Ensure Firebase config is correctly loaded.", 'error');
                console.error("Login attempt failed: Firebase Auth object is null. Ensure Firebase config is correctly loaded.");
                return;
            }
            try {
                await signInWithEmailAndPassword(window.auth, email, password);
                showMessageBox("Logged in successfully!", 'success');
                console.log("User logged in successfully with email:", email);
            } catch (error) {
                console.error("Login error:", error.code, error.message);
                // Custom error message for wrong email/password
                if (error.code === 'auth/invalid-credential' || // Generic error for wrong email/password combined (newer Firebase versions)
                    error.code === 'auth/wrong-password' ||
                    error.code === 'auth/user-not-found') {
                    showMessageBox("Wrong email/password", 'error');
                } else {
                    showMessageBox(`Login failed: ${error.message}`, 'error');
                }
            }
        }

        async function handleSignUp() {
            console.log("handleSignUp function called.");
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            if (!email || !password) {
                showMessageBox("Please enter both email and password.", 'error');
                console.error("Sign up attempt failed: Email or password missing.");
                return;
            }
            if (!window.auth) {
                showMessageBox("Firebase Auth not initialized. Cannot sign up. Ensure Firebase config is correctly loaded.", 'error');
                console.error("Sign up attempt failed: Firebase Auth object is null. Ensure Firebase config is correctly loaded.");
                return;
            }
            try {
                await createUserWithEmailAndPassword(window.auth, email, password);
                showMessageBox("Signed up successfully! You are now logged in.", 'success');
                console.log("User signed up and logged in successfully with email:", email);
            } catch (error) {
                showMessageBox(`Sign up failed: ${error.message}`, 'error');
                console.error("Sign up error:", error.code, error.message);
            }
        }

        async function handleGoogleLogin() {
            console.log("handleGoogleLogin function called.");
            if (!window.auth) {
                showMessageBox("Firebase Auth not initialized. Cannot sign in with Google.", 'error');
                console.error("Google Login attempt failed: Firebase Auth object is null. Ensure Firebase config is correctly loaded.");
                return;
            }
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(window.auth, provider);
                showMessageBox("Signed in with Google successfully!", 'success');
                console.log("User signed in with Google successfully.");
            } catch (error) {
                showMessageBox(`Google Sign-in failed: ${error.message}`, 'error');
                console.error("Google Sign-in error:", error.code, error.message);
            }
        }

        async function handleLogout() {
            console.log("handleLogout function called.");
            if (!window.auth) {
                showMessageBox("Firebase Auth not initialized. Cannot log out.", 'error');
                console.error("Logout attempt failed: Firebase Auth object is null.");
                return;
            }
            try {
                await signOut(window.auth);
                showMessageBox("Logged out successfully!", 'success');
                console.log("User logged out successfully.");
            } catch (error) {
                showMessageBox(`Logout failed: ${error.message}`, 'error');
                console.error("Logout error:", error.code, error.message);
            }
        }

        /**
         * Event listener for the Reset Data button.
         * Now clears both tracker data from Firestore (if logged in) and local storage.
         */
        async function handleResetData() {
            console.log("handleResetData function called.");
            if (confirm("Are you sure you want to reset ALL your tracker data? This action cannot be undone.")) {
                if (window.userId && window.db) {
                    try {
                        const trackerDocRef = getTrackerDocRef(window.userId);
                        // Explicitly delete the document to ensure a clean slate for initializeTrackerDataAndSave
                        await deleteDoc(trackerDocRef);
                        showMessageBox("Account data cleared. Initializing new data...", 'success');
                        console.log("handleResetData: Firestore account data (tracker) cleared successfully. onSnapshot will re-init.");
                        // initializeTrackerDataAndSave() will be triggered by the onSnapshot listener after delete
                    } catch (e) {
                        console.error("handleResetData: Error clearing Firestore data:", e);
                        showMessageBox("Error clearing account data.", 'error');
                    }
                }

                // Clear local storage regardless, for a clean slate
                localStorage.removeItem(localStorageKey);
                console.log("handleResetData: Local storage data cleared.");

                // The onAuthStateChanged listener will handle re-initialization if the user is still logged in
                // or if they log in again later. If data was deleted, the onSnapshot will trigger
                // initializeTrackerDataAndSave.
                document.getElementById('aiGuidanceContent').innerHTML = '<p class="text-center text-gray-500">Click "Get AI Guidance" to receive personalized feedback!</p>';
                showMessageBox("All data has been reset!", 'error');
            }
        }

        /**
         * Initializes the application: Firebase, auth listener, and UI setup.
         */
        function initApp() {
            console.log("initApp: started.");
            if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
                console.log("initApp: Firebase config found:", firebaseConfig);
                window.firebaseApp = initializeApp(firebaseConfig);
                window.auth = getAuth(window.firebaseApp);
                window.db = getFirestore(window.firebaseApp);
                console.log("initApp: Firebase initialized successfully. Auth object:", window.auth, "DB object:", window.db);

                console.log("initApp: Automatic sign-in via custom token/anonymous removed. Please use Email/Password or Google login.");

                // Attach event listeners for auth UI
                const loginBtn = document.getElementById('loginBtn');
                const signupBtn = document.getElementById('signupBtn');
                const googleLoginBtn = document.getElementById('googleLoginBtn');
                const logoutBtn = document.getElementById('logoutBtn');
                const getAIGuidanceBtn = document.getElementById('getAIGuidanceBtn');
                const resetDataBtn = document.getElementById('resetDataBtn');

                if (loginBtn) {
                    loginBtn.addEventListener('click', handleLogin);
                    console.log("initApp: Event listener attached to loginBtn.");
                } else { console.error("initApp: loginBtn not found. Check HTML structure."); }
                if (signupBtn) {
                    signupBtn.addEventListener('click', handleSignUp);
                    console.log("initApp: Event listener attached to signupBtn.");
                } else { console.error("initApp: signupBtn not found. Check HTML structure."); }
                if (googleLoginBtn) {
                    googleLoginBtn.addEventListener('click', handleGoogleLogin);
                    console.log("initApp: Event listener attached to googleLoginBtn.");
                } else { console.error("initApp: googleLoginBtn not found. Check HTML structure."); }
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', handleLogout);
                    console.log("initApp: Event listener attached to logoutBtn.");
                } else { console.error("initApp: logoutBtn not found. Check HTML structure."); }

                if (getAIGuidanceBtn) {
                    getAIGuidanceBtn.addEventListener('click', getAIGuidance);
                    console.log("initApp: Event listener attached to getAIGuidanceBtn.");
                } else { console.error("initApp: getAIGuidanceBtn not found."); }
                if (resetDataBtn) {
                    resetDataBtn.addEventListener('click', handleResetData);
                    console.log("initApp: Event listener attached to resetDataBtn.");
                } else { console.error("initApp: resetDataBtn not found."); }

                // Listen for authentication state changes
                onAuthStateChanged(window.auth, (user) => {
                    console.log("onAuthStateChanged: triggered. User:", user ? user.uid : "null");
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('userEmail').textContent = user.email || user.displayName || 'Anonymous';
                        document.getElementById('userIdDisplay').textContent = user.uid.substring(0, 8) + '...';
                        document.getElementById('loginForm').classList.add('hidden');
                        document.getElementById('userInfo').classList.remove('hidden');
                        document.getElementById('appContent').classList.remove('hidden'); // Show tracker
                        showMessageBox("Welcome, " + (user.email || user.displayName || "Anonymous User") + "!");
                        console.log("onAuthStateChanged: User logged in. UID:", window.userId, "Email:", user.email);

                        loadTrackerAndSettingsData(); // Load user-specific data from Firestore (tracker data)

                    } else {
                        window.userId = null;
                        if (window.currentUnsubscribe) {
                            window.currentUnsubscribe(); // Detach Firestore listener on logout
                            window.currentUnsubscribe = null;
                            console.log("onAuthStateChanged: Firestore listener detached.");
                        }
                        document.getElementById('loginForm').classList.remove('hidden');
                        document.getElementById('userInfo').classList.add('hidden');
                        document.getElementById('appContent').classList.add('hidden'); // Hide tracker
                        window.trackerData = []; // Clear current data in memory
                        renderTable(); // Clear table display
                        document.getElementById('aiGuidanceContent').innerHTML = '<p class="text-center text-gray-500">Click "Get AI Guidance" to receive personalized feedback!</p>';
                        showMessageBox("Please log in to access your tracker.", 'info');
                        console.log("onAuthStateChanged: User logged out.");
                    }
                });
            } else {
                showMessageBox("Firebase configuration not found. Please ensure Firebase is set up correctly in the environment.", 'error');
                console.error("initApp: Firebase config is missing or empty. Please ensure your Firebase config is correctly defined in the code.");
                // Disable functionality if Firebase cannot be initialized
                const loginBtn = document.getElementById('loginBtn');
                const signupBtn = document.getElementById('signupBtn');
                const googleLoginBtn = document.getElementById('googleLoginBtn');
                const getAIGuidanceBtn = document.getElementById('getAIGuidanceBtn');
                const resetDataBtn = document.getElementById('resetDataBtn');

                if (loginBtn) {
                    loginBtn.disabled = true;
                    loginBtn.textContent = "Firebase Not Configured";
                }
                if (signupBtn) {
                    signupBtn.disabled = true;
                    signupBtn.textContent = "Firebase Not Configured";
                }
                if (googleLoginBtn) {
                    googleLoginBtn.disabled = true;
                    googleLoginBtn.textContent = "Firebase Not Configured";
                }
                if (getAIGuidanceBtn) getAIGuidanceBtn.disabled = true;
                if (resetDataBtn) resetDataBtn.disabled = true;

                document.getElementById('emailInput').placeholder = "Firebase not configured";
                document.getElementById('passwordInput').placeholder = "Firebase not configured";
                console.log("initApp: Firebase not configured. Buttons disabled and placeholder text updated.");
            }
        }
        // Ensure initApp is called when the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
